---
title: 'Student List Business'
mode: selfcontained
ext_widgets : {rCharts: [libraries/shiny]}
framework: revealjs
revealjs:
  theme: 'custom'
  transition: 'slide'
  center: 'false'
bibliography: '../assets/bib/student_list_policy.bib'
csl: '../assets/bib/apa.csl'

--- #title

```{r, include = F}
knitr::opts_chunk$set(echo = F, message = F, warning = F, out.width = '90%', dpi = 300)

library(xtable)
library(RColorBrewer)
library(patchwork)

options(scipen = 999, xtable.type = 'html', xtable.include.rownames = F)


library(slidify)
library(slidifyLibraries)
# slidify('slides/student_list_dognpony.Rmd')

library(servr)
# Start server: servr::httd()
# Check if server(s) running: daemon_list()
# Stop server(s): daemon_stop(which = daemon_list())

library(knitcitations)

cleanbib()
bib <- read.bibtex('../assets/bib/student_list_policy.bib')

library(gridExtra) # for creating howell table
library(tidyverse)
library(ggbreak)
library(scales)
library(usmap)

# Function for parenthetical citation needing `e.g.,` or have no year (ie. forthcoming)
# b: citation(s)
# eg: T/F - whether or not to include `e.g.,` in citation
cite <- function(b, eg = TRUE) {
  c <- ifelse(eg, '(e.g., ', '(')
  for (i in seq_along(b)) {
    if (i != 1) {
      c <- paste0(c, '; ')
    }
    a <- paste(b[[i]]$author$family, collapse = ', ')
    y <- ifelse(is.null(b[[i]]$year), 'forthcoming', b[[i]]$year)
    entry <- paste(a, y, sep = ', ')
    c <- paste0(c, entry)
    record_as_cited(b[[i]])
  }
  paste0(c, ')')
}

load(url('https://github.com/mpatricia01/public_requests_eda/raw/main/data/tbl_fig_data_final.RData'))
univ_status <- read_csv(url('https://github.com/mpatricia01/public_requests_eda/raw/main/data/univ_status.csv'))

theme_set(
  theme(
    text = element_text(size = 7, family = 'Helvetica'),
    panel.background = element_rect(fill = '#f0f0f0', color = NA),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    plot.background = element_rect(fill = '#f0f0f0', color = NA),
    plot.title = element_text(color = '#444444', size = 7, face = 'bold', hjust = 0.5),
    axis.ticks = element_blank(),
    axis.title = element_text(face = 'bold'),
    legend.background = element_rect(fill = '#f0f0f0', color = NA),
    legend.title = element_text(face = 'bold', hjust = 0),
    legend.key.size = unit(0.3, 'cm'),
    strip.text.x = element_text(size = 7, face = 'bold', hjust = 0.5),
    strip.background = element_rect(fill = NA, color = NA)
  )
)

color_palette <- c('#bbcfd7', '#d2c8bc', '#ba9a88')
color_gradient <- brewer.pal(9, 'BrBG')
color_text <- 'black'
alpha_bar <- 0.4

num_orders <- nrow(orders_df)
num_orders_w_list <- sum(orders_df$order_num %in% lists_df_summary$ord_num)
num_orders_no_list <- num_orders - num_orders_w_list
num_univs_orders <- length(unique(orders_df$univ_id))

num_lists <- length(na.omit(lists_df_summary$ord_num))
num_univs_lists <- length(unique(lists_df_summary$univ_id))

num_prospects <- sum(lists_df_summary$n)
num_prospects_w_order <- sum((lists_df_summary %>% filter(ord_num %in% orders_df$order_num))$n)
num_prospects_no_order <- sum((lists_df_summary %>% filter(!ord_num %in% orders_df$order_num))$n)

univs_summary <- orders_df %>% 
  select(univ_id, univ_name, univ_type) %>% 
  distinct() %>% mutate(has_order = T) %>% 
  left_join(
    lists_df_summary %>% 
      select(univ_id) %>% 
      distinct() %>% 
      mutate(has_list = T)
    , by = 'univ_id'
  )

# RQ1
num_univs_orders_research <- sum(orders_prospects_purchased$univ_type == 'research')
num_univs_orders_regional <- sum(orders_prospects_purchased$univ_type == 'regional')

num_orders_research <- sum((orders_prospects_purchased %>% filter(univ_type == 'research'))$total_orders)
num_orders_regional <- sum((orders_prospects_purchased %>% filter(univ_type == 'regional'))$total_orders)

orders_filters_totals <- orders_filters %>% 
  filter(is_asu == 'all') %>% 
  mutate(category = str_c(univ_type, filters, sep = '_'), pct = if_else(pct < 0.01, round(pct * 100, 1), round(pct * 100))) %>% 
  select(category, pct) %>% 
  deframe()

# RQ2
rq2_race_research_outofstate <- rq2_race %>% 
  filter(univ_type == 'research', region == 'domestic', locale == 'outofstate') %>%
  mutate(race = as_factor(stu_race_cb), pct = if_else(pct < 0.01, round(pct * 100, 1), round(pct * 100))) %>% 
  select(race, pct) %>% 
  deframe()

rq2_race_research_outofstate_full <- rq2_race_full %>% 
  filter(univ_type == 'research', region == 'domestic', locale == 'outofstate') %>%
  mutate(race = if_else(is.na(stu_race_cb), 'unknown', as.character(as_factor(stu_race_cb))), pct = if_else(pct < 0.01, round(pct * 100, 1), round(pct * 100))) %>% 
  select(race, pct) %>% 
  deframe()

rq2_race_research_instate <- rq2_race %>% 
  filter(univ_type == 'research', region == 'domestic', locale == 'instate') %>%
  mutate(race = as_factor(stu_race_cb), pct = if_else(pct < 0.01, round(pct * 100, 1), round(pct * 100))) %>% 
  select(race, pct) %>% 
  deframe()

rq2_race_research_instate_full <- rq2_race_full %>% 
  filter(univ_type == 'research', region == 'domestic', locale == 'instate') %>%
  mutate(race = if_else(is.na(stu_race_cb), 'unknown', as.character(as_factor(stu_race_cb))), pct = if_else(pct < 0.01, round(pct * 100, 1), round(pct * 100))) %>% 
  select(race, pct) %>% 
  deframe()

rq2_race_regional_instate <- rq2_race %>% 
  filter(univ_type == 'regional', region == 'domestic', locale == 'instate') %>%
  mutate(race = as_factor(stu_race_cb), pct = if_else(pct < 0.01, round(pct * 100, 1), round(pct * 100))) %>% 
  select(race, pct) %>% 
  deframe()

rq2_race_regional_instate_full <- rq2_race_full %>% 
  filter(univ_type == 'regional', region == 'domestic', locale == 'instate') %>%
  mutate(race = if_else(is.na(stu_race_cb), 'unknown', as.character(as_factor(stu_race_cb))), pct = if_else(pct < 0.01, round(pct * 100, 1), round(pct * 100))) %>% 
  select(race, pct) %>% 
  deframe()

rq2_locale_research_outofstate <- rq2_locale %>% 
  filter(univ_type == 'research', region == 'domestic', locale == 'outofstate') %>%
  mutate(pct = if_else(pct < 0.01, round(pct * 100, 1), round(pct * 100))) %>% 
  select(locale_text, pct) %>% 
  deframe()

rq2_locale_research_instate <- rq2_locale %>% 
  filter(univ_type == 'research', region == 'domestic', locale == 'instate') %>%
  mutate(pct = if_else(pct < 0.01, round(pct * 100, 1), round(pct * 100))) %>% 
  select(locale_text, pct) %>% 
  deframe()

rq2_locale_regional_instate <- rq2_locale %>% 
  filter(univ_type == 'regional', region == 'domestic', locale == 'instate') %>%
  mutate(pct = if_else(pct < 0.01, round(pct * 100, 1), round(pct * 100))) %>% 
  select(locale_text, pct) %>% 
  deframe()

# RQ3
rq3_poc <- round(rq3 %>% filter(row_subj %in% c('pct_black', 'pct_latinx', 'pct_aian')) %>% select(-row_subj) %>% colSums() * 100)

rq3_income <- prettyNum(round(rq3 %>% filter(row_subj == 'med_income') %>% select(-row_subj) / 1e3) * 1e3, ',')

rq3_instate <- round(rq3 %>% filter(row_subj == 'pct_instate') %>% select(-row_subj) * 100)
rq3_outofstate <- round(rq3 %>% filter(row_subj == 'pct_outofstate') %>% select(-row_subj) * 100)

asu_la_totals <- asu_la_full %>%
  group_by(ord_type, in_zip_top10pct) %>% 
  summarise(count = sum(count)) %>% 
  ungroup() %>% 
  mutate(category = str_c(ord_type, if_else(in_zip_top10pct == 1, 'top10', 'bottom90'), sep = '_')) %>% 
  select(category, count) %>% 
  deframe()

asu_la_psat_high_top10 <- asu_la %>% 
  filter(ord_type == 'psat_high', in_zip_top10pct == 1) %>%
  mutate(race = as_factor(stu_race_cb), pct = if_else(pct < 0.01, round(pct * 100, 1), round(pct * 100))) %>% 
  select(race, pct) %>% 
  deframe()

asu_la_psat_high_top10_full <- asu_la_full %>% 
  filter(ord_type == 'psat_high', in_zip_top10pct == 1) %>%
  mutate(race = if_else(is.na(stu_race_cb), 'unknown', as.character(as_factor(stu_race_cb))), pct = if_else(pct < 0.01, round(pct * 100, 1), round(pct * 100))) %>% 
  select(race, pct) %>% 
  deframe()

asu_la_psat_high_bottom90 <- asu_la %>% 
  filter(ord_type == 'psat_high', in_zip_top10pct == 0) %>%
  mutate(race = as_factor(stu_race_cb), pct = if_else(pct < 0.01, round(pct * 100, 1), round(pct * 100))) %>% 
  select(race, pct) %>% 
  deframe()

asu_la_psat_high_bottom90_full <- asu_la_full %>% 
  filter(ord_type == 'psat_high', in_zip_top10pct == 0) %>%
  mutate(race = if_else(is.na(stu_race_cb), 'unknown', as.character(as_factor(stu_race_cb))), pct = if_else(pct < 0.01, round(pct * 100, 1), round(pct * 100))) %>% 
  select(race, pct) %>% 
  deframe()

asu_la_psat_med_top10 <- asu_la %>% 
  filter(ord_type == 'psat_med', in_zip_top10pct == 1) %>%
  mutate(race = as_factor(stu_race_cb), pct = if_else(pct < 0.01, round(pct * 100, 1), round(pct * 100))) %>% 
  select(race, pct) %>% 
  deframe()

asu_la_psat_med_top10_full <- asu_la_full %>% 
  filter(ord_type == 'psat_med', in_zip_top10pct == 1) %>%
  mutate(race = if_else(is.na(stu_race_cb), 'unknown', as.character(as_factor(stu_race_cb))), pct = if_else(pct < 0.01, round(pct * 100, 1), round(pct * 100))) %>% 
  select(race, pct) %>% 
  deframe()

asu_la_psat_med_bottom90 <- asu_la %>% 
  filter(ord_type == 'psat_med', in_zip_top10pct == 0) %>%
  mutate(race = as_factor(stu_race_cb), pct = if_else(pct < 0.01, round(pct * 100, 1), round(pct * 100))) %>% 
  select(race, pct) %>% 
  deframe()

asu_la_psat_med_bottom90_full <- asu_la_full %>% 
  filter(ord_type == 'psat_med', in_zip_top10pct == 0) %>%
  mutate(race = if_else(is.na(stu_race_cb), 'unknown', as.character(as_factor(stu_race_cb))), pct = if_else(pct < 0.01, round(pct * 100, 1), round(pct * 100))) %>% 
  select(race, pct) %>% 
  deframe()

asu_la_psat_low_top10 <- asu_la %>% 
  filter(ord_type == 'psat_low', in_zip_top10pct == 1) %>%
  mutate(race = as_factor(stu_race_cb), pct = if_else(pct < 0.01, round(pct * 100, 1), round(pct * 100))) %>% 
  select(race, pct) %>% 
  deframe()

asu_la_psat_low_top10_full <- asu_la_full %>% 
  filter(ord_type == 'psat_low', in_zip_top10pct == 1) %>%
  mutate(race = if_else(is.na(stu_race_cb), 'unknown', as.character(as_factor(stu_race_cb))), pct = if_else(pct < 0.01, round(pct * 100, 1), round(pct * 100))) %>% 
  select(race, pct) %>% 
  deframe()

asu_la_psat_low_bottom90 <- asu_la %>% 
  filter(ord_type == 'psat_low', in_zip_top10pct == 0) %>%
  mutate(race = as_factor(stu_race_cb), pct = if_else(pct < 0.01, round(pct * 100, 1), round(pct * 100))) %>% 
  select(race, pct) %>% 
  deframe()

asu_la_psat_low_bottom90_full <- asu_la_full %>% 
  filter(ord_type == 'psat_low', in_zip_top10pct == 0) %>%
  mutate(race = if_else(is.na(stu_race_cb), 'unknown', as.character(as_factor(stu_race_cb))), pct = if_else(pct < 0.01, round(pct * 100, 1), round(pct * 100))) %>% 
  select(race, pct) %>% 
  deframe()

asu_la_sat_med_top10 <- asu_la %>% 
  filter(ord_type == 'sat_med', in_zip_top10pct == 1) %>%
  mutate(race = as_factor(stu_race_cb), pct = if_else(pct < 0.01, round(pct * 100, 1), round(pct * 100))) %>% 
  select(race, pct) %>% 
  deframe()

asu_la_sat_med_top10_full <- asu_la_full %>% 
  filter(ord_type == 'sat_med', in_zip_top10pct == 1) %>%
  mutate(race = if_else(is.na(stu_race_cb), 'unknown', as.character(as_factor(stu_race_cb))), pct = if_else(pct < 0.01, round(pct * 100, 1), round(pct * 100))) %>% 
  select(race, pct) %>% 
  add_row(race = 'unknown', pct = 0) %>%
  deframe()

asu_la_sat_med_bottom90 <- asu_la %>% 
  filter(ord_type == 'sat_med', in_zip_top10pct == 0) %>%
  mutate(race = as_factor(stu_race_cb), pct = if_else(pct < 0.01, round(pct * 100, 1), round(pct * 100))) %>% 
  select(race, pct) %>% 
  deframe()

asu_la_sat_med_bottom90_full <- asu_la_full %>% 
  filter(ord_type == 'sat_med', in_zip_top10pct == 0) %>%
  mutate(race = if_else(is.na(stu_race_cb), 'unknown', as.character(as_factor(stu_race_cb))), pct = if_else(pct < 0.01, round(pct * 100, 1), round(pct * 100))) %>% 
  select(race, pct) %>% 
  deframe()

uiuc_totals <- uiuc_race_full %>%
  filter(ord_type == 'prospect') %>% 
  group_by(cbsa_code, cbsa_name) %>% 
  summarise(count = sum(count)) %>% 
  ungroup() %>% 
  mutate(category = recode(cbsa_code, '31080' = 'la', '35620' = 'ny', '37980' = 'philly', '47900' = 'dc')) %>% 
  select(category, count) %>% 
  deframe()

uiuc_race_pct <- uiuc_race %>% 
  mutate(category = str_c(recode(cbsa_code, '31080' = 'la', '35620' = 'ny', '37980' = 'philly', '47900' = 'dc'), ord_type, race, sep = '_'), pct = if_else(pct < 0.01, round(pct * 100, 1), round(pct * 100))) %>% 
  select(category, pct) %>% 
  deframe()

uiuc_race_full_pct <- uiuc_race_full %>% 
  mutate(category = str_c(recode(cbsa_code, '31080' = 'la', '35620' = 'ny', '37980' = 'philly', '47900' = 'dc'), ord_type, race, sep = '_'), pct = if_else(pct < 0.01, round(pct * 100, 1), round(pct * 100))) %>% 
  select(category, pct) %>% 
  deframe()

uiuc_income_2564 <- uiuc_income %>% 
  mutate(category = str_c(recode(cbsa_code, '31080' = 'la', '35620' = 'ny', '37980' = 'philly', '47900' = 'dc'), ord_type, sep = '_'), income_2564 = prettyNum(round(income_2564 / 1e3) * 1e3, ',')) %>% 
  select(category, income_2564) %>% 
  deframe()

ucsd_all_race_pct <- ucsd_all_race %>% 
  mutate(category = str_c(ord_type, race, sep = '_'), pct = if_else(pct < 0.01, round(pct * 100, 1), round(pct * 100))) %>% 
  select(category, pct) %>% 
  deframe()

ucsd_all_race_full_pct <- ucsd_all_race_full %>% 
  mutate(category = str_c(ord_type, race, sep = '_'), pct = if_else(pct < 0.01, round(pct * 100, 1), round(pct * 100))) %>% 
  select(category, pct) %>% 
  deframe()

ucsd_totals <- ucsd_race_full %>%
  group_by(cbsa_code, cbsa_name, ord_type) %>% 
  summarise(count = sum(count)) %>% 
  ungroup() %>% 
  mutate(category = str_c(recode(cbsa_code, '12060' = 'atl', '16980' = 'chicago', '35620' = 'ny', '42660' = 'seattle'), ord_type, sep = '_')) %>% 
  select(category, count) %>% 
  deframe()

ucsd_race_pct <- ucsd_race %>% 
  mutate(category = str_c(recode(cbsa_code, '12060' = 'atl', '16980' = 'chicago', '35620' = 'ny', '42660' = 'seattle'), ord_type, race, sep = '_'), pct = if_else(pct < 0.01, round(pct * 100, 1), round(pct * 100))) %>% 
  select(category, pct) %>% 
  deframe()

ucsd_race_full_pct <- ucsd_race_full %>% 
  mutate(category = str_c(recode(cbsa_code, '12060' = 'atl', '16980' = 'chicago', '35620' = 'ny', '42660' = 'seattle'), ord_type, race, sep = '_'), pct = if_else(pct < 0.01, round(pct * 100, 1), round(pct * 100))) %>% 
  select(category, pct) %>% 
  deframe()

ucsd_income_2564 <- ucsd_income %>% 
  mutate(category = str_c(recode(cbsa_code, '12060' = 'atl', '16980' = 'chicago', '35620' = 'ny', '42660' = 'seattle'), ord_type, sep = '_'), income_2564 = prettyNum(round(income_2564 / 1e3) * 1e3, ',')) %>% 
  select(category, income_2564) %>% 
  deframe()

poc_totals <- poc_cb %>%
  group_by(cbsa_code, cbsa_name) %>% 
  summarise(count = sum(count)) %>% 
  ungroup() %>% 
  mutate(category = recode(cbsa_code, '26420' = 'houston', '33100' = 'miami', '35620' = 'ny')) %>% 
  select(category, count) %>% 
  deframe()

poc_cb_pct <- poc_cb %>% 
  mutate(category = str_c(recode(cbsa_code, '26420' = 'houston', '33100' = 'miami', '35620' = 'ny'), race, sep = '_'), pct = if_else(pct < 0.01, round(pct * 100, 1), round(pct * 100))) %>% 
  select(category, pct) %>% 
  deframe()

poc_common_pct <- poc_common %>% 
  mutate(category = str_c(recode(cbsa_code, '26420' = 'houston', '33100' = 'miami', '35620' = 'ny'), race, sep = '_'), pct = if_else(pct < 0.01, round(pct * 100, 1), round(pct * 100))) %>% 
  select(category, pct) %>% 
  deframe()

poc_hs_pct <- poc_hs %>% 
  mutate(category = str_c(recode(cbsa_code, '26420' = 'houston', '33100' = 'miami', '35620' = 'ny'), ord_type, control, sep = '_'), pct = if_else(pct < 0.01, round(pct * 100, 1), round(pct * 100))) %>% 
  select(category, pct) %>% 
  deframe()

poc_race_pct <- poc_race %>% 
  mutate(category = str_c(recode(cbsa_code, '26420' = 'houston', '33100' = 'miami', '35620' = 'ny'), ord_type, race, sep = '_'), pct = if_else(pct < 0.01, round(pct * 100, 1), round(pct * 100))) %>% 
  select(category, pct) %>% 
  deframe()

poc_income_2564 <- poc_income %>% 
  mutate(category = str_c(recode(cbsa_code, '26420' = 'houston', '33100' = 'miami', '35620' = 'ny'), ord_type, sep = '_'), income_2564 = prettyNum(round(income_2564 / 1e3) * 1e3, ',')) %>% 
  select(category, income_2564) %>% 
  deframe()
```


# The Student List Business

<div id='authors'>
  <div><p>Ozan Jaquette</p><span class='affiliation'>UCLA</span></div>
  <div><p>Karina Salazar</p><span class='affiliation'>University of Arizona</span></div>
  <div><p>Patrica Martín</p><span class='affiliation'>UCLA</span></div>
</div>


--- .section

# Introduction


---

# CB Search and student outcomes
## `r citet(bib['RN4739'])`

```{r cb-fig, fig.height = 5}
create_cb_figure <- function(categories, values, plot_title, fill_values = rev(color_palette[1:2])) {
  cb_fig_df <- data.frame(
    category = rep(categories, each = 2),
    subcategory = rep(c('Not Licensed', 'Gain from being Licensed'), length(categories)), 
    value = values
  )
  
  cb_fig_df$category <- factor(cb_fig_df$category, levels = categories)
  
  cb_fig_df %>%
    left_join(
      cb_fig_df %>%
        pivot_wider(id_cols = category, names_from = subcategory, values_from = value) %>%
        mutate(
          total = `Not Licensed` + `Gain from being Licensed`,
          pct_change = `Gain from being Licensed` / `Not Licensed` * 100
        ),
      by = 'category') %>% 
    ggplot(aes(x = category, y = value, fill = subcategory, width = 0.6)) +
    geom_bar(position = 'stack', stat = 'identity') +
    geom_text(aes(y = value, label = if_else(subcategory == 'Not Licensed', str_c(sprintf('%.1f', value), '%'), '')), color = '#444444', size = 2, position = position_stack(vjust = 0.5)) +
    geom_text(aes(y = total + 3, label = if_else(subcategory == 'Not Licensed', str_c('(', sprintf('%.1f', pct_change), '%)'), '')), color = '#444444', size = 2) +
    geom_text(aes(y = total + 7, label = if_else(subcategory == 'Not Licensed', str_c(sprintf('%.1f', `Gain from being Licensed`), 'pp'), '')), color = '#444444', size = 2) +
    ggtitle(plot_title) +
    xlab('') + ylab('') + 
    scale_y_continuous(expand = expansion(mult = c(0, 0.05)), limits = c(0, 80)) +
    scale_fill_manual(values = fill_values) +
    theme(
        plot.margin = margin(t = 0.6, unit = 'cm'),
        panel.grid.major.y = element_line(size = 0.1, color = 'gray'),
        legend.title = element_blank(),
        legend.position = 'bottom',
        legend.margin = margin(t = -0.5, unit = 'cm'),
        legend.text = element_text(margin = margin(r = 0.2, unit = 'cm'))
      ) +
      guides(fill = guide_legend(reverse = T))
}

grid.arrange(
  create_cb_figure(
    c('Overall', 'Asian', 'Black', 'Hispanic', 'AI/AN', 'HI/PI', 'White'),
    c(32.8, 8.3, 37.5, 5.7, 31.8, 7.8, 24.1, 8.3, 26.5, 6.3, 22.2, 5.8, 44.4, 9.6),
    'Enrollment'
  ),
  create_cb_figure(
    c('Overall', 'Asian', 'Black', 'Hispanic', 'AI/AN', 'White'),
    c(15.7, 4.9, 17.7, 5.0, 7.2, 2.9, 6.7, 2.9, 8.7, 4.2, 24.0, 6.7),
    'BA Completion within 4 Years'
  ),
  create_cb_figure(
    c('Overall', 'No College', 'College,\nNo BA', 'College,\nBA or Higher'),
    c(32.8, 8.3, 24.9, 10.1, 36.5, 11.0, 53.4, 10.1),
    'Enrollment'
  ),
  create_cb_figure(
    c('Overall', 'No College', 'College,\nNo BA', 'College,\nBA or Higher'),
    c(15.7, 4.9, 13.6, 6.8, 21.3, 8.5, 39.9, 10.1),
    'BA Completion within 4 Years'
  ),
  ncol = 2
)
```


---

# How could lists be so important?
## The US market for higher education


Title IV institutions
- Allowed to enroll students that receive federal financial aid

<br>

A national voucher system
- Federal/state student aid, household savings follow students to institutions

<br>

Tuition is largest revenue source
- Title IV institutions have incentive to enroll students who receive federal student aid

<br>

Problems
- Students don't know all their options, don't know which institutions interested in them
- Institutions don't know who the prospects are or how to contact them

<br>

Student lists
- A matchmaking intermediary that connects institutions to prospects


--- .subsection

# The student list project


--- 

## Project overview

Data collection

- Issued public records requests to all public universities in four states (CA, IL, MN, TX)
- Target student list vendors
  - College Board, ACT
- Data collection began February 2020  
  - Seeking student lists purchased from 2016-2020

<br>
For each purchased list, sought two pieces of data

1. "Order summary" specifying search filter criteria ([LINK](https://drive.google.com/file/d/1gPZ-WWw0gdFT7VtzBN3hKLnj2DzoaqnY/view))
1. De-identified prospect-level student list ([LINK](https://drive.google.com/file/d/1Qvc_QRi9izEF1W78Lh4nNi5NsXjCZqUE/view))

<br>
Empirical research questions

1. Which filter criteria were selected in student lists purchases?
1. What are the characteristics of prospects included in student lists purchases?
1. What is the relationship between student list filter criteria and the characteristics of
purchased prospects?

<br>
Partners

- Funded by Joyce Foundation, Kresge Foundation
- Pro bono partnership with a civil rights legal organization and four multinational law firms
- Our first report to be published by [ACCEPT](https://www.acceptgroup.org/)


---

## What we learned


Began the project with a focus on university behavior

- Which universities doing a "good" vs. "bad" job of reaching out to the community?
- This was the wrong focus!

<br>
What we learned
- The student list products themselves are problematic
- Often, name buys outsourced to consultancy and university employees lacked knowledge
- Radical transformation in market for student list data happening right now
  - For-profit suppliers entered the market
  - Distinction between consulting firms and student list vendor has blurred
  - Test-optional

<br>
Revised focus
- Student list products
- Dynamics and key players in the market for student list data



--- .section

# The Student List Business


--- .subsection

# Student list basics


--- .subsubsection

# Situating the student list business
## How industries find customers


**Lead generation**

- Connect consumers interested in products (leads) to merchants who sell those products `r citep(bib['ftc2016'])`

<br>
__List-based leads__, based on the direct mail model

- "Publisher" obtains information about customers >>
  - Often, publisher sells data to "aggregator" >>
  - Publisher/aggregator sells data to merchant >>
  - Merchant serves marketing material to consumers via purchased contact info
- Student lists are example of list-based lead generation

<br>
__Behavioral-based leads__ (e.g., Google Search)

- Target (*verb*) users of a platform (e.g., Twitter)
- Identify targets (*noun*) based on user profile, simultaneously serve ads while they are on platform
  - Also, serve ads when they visit website that partners with the platform (e.g., Google Display Network)


<br>
Finding customers in higher education

- Buy lists from College Board and ACT to identify college-bound high school students `r citep(bib['RN4728'])`
- Behavioral based marketing to target markets where reliable student lists are unavailable
  - e.g., community college and for-profit credentials, online program managers (OPMs) recruiting adults
  - Additionally, behavioral based marketing for brand awareness


--- &twocol

## The enrollment funnel

*** =left

<center>**The marketing funnel**</center>


<br>

<img src="../assets/images/marketing-funnel-diagram.png" alt="Enrollment Funnel" style="width:90%;margin:0 auto;">

Source: [skyword.com](https://www.skyword.com/contentstandard/how-the-marketing-funnel-works-from-top-to-bottom/)

*** =right

<center>**The enrollment funnel**</center>

<br>

<img src="../assets/images/enrollment_funnel.png" alt="Enrollment Funnel" style="width:80%;margin:0 auto;">

Source: [pngwing.com](https://www.pngwing.com/en/free-png-krrpy)


--- &twocol

## The enrollment funnel

*** =left

Prospects

- Population of desirable potential students

Leads

- Prospects whose contact info has been obtained

Inquiries

- Prospects who have contacted the institution
  - Institution as first contact (leads)
  - Student as first contact

<br>
Interventions along the funnel

- Convert prospects to leads
  - purchase student lists
- Convert leads/inquiries to applicants
  - Email, mail, targeted social media
- Convert admits to enrolles
  - Financial aid packages

*** =right

<center>**The enrollment funnel**</center>

<br>

<img src="../assets/images/enrollment_funnel.png" alt="Enrollment Funnel" style="width:80%;margin:0 auto;">

Source: [pngwing.com](https://www.pngwing.com/en/free-png-krrpy)




--- .subsubsection

# College Board and ACT lists
## Data sources and list contents

College Board and ACT have been largest student list vendors for several decades

- College Board "Student Search Service" created in 1972 `r citep(bib['belkin2019-studata'])`
- ACT "Educational Opportunity Service"
  - ACT acquired National Research Center for College and University (NRCCUA) in 2018
  - Student list products part of new "Encoura Data Lab"

<br>
Source of student list data

- Create student list data from database of test takers (e.g., PSAT, SAT, AP, PreACT, ACT)
  - Pre-test questionnaire (e.g., demographic, preferences about college)
- Students have opportunity to opt in or opt out of student list products

<br>
Pricing

- Historically, a price-per-prospect model
- ACT moved to subscription pricing with [creation of Encoura](https://encoura.org/combined-data-set/)
- College Board currently charges \$0.50 per name, but [moving to subscription pricing](https://cbsearch.collegeboard.org/pdf/2022-23-subscription-plan-pricing.pdf) too

<br>
What information does a list contain
- Contact, demographic, college preferences, limited academic achievement
- College Board template [HERE](https://drive.google.com/file/d/1Qvc_QRi9izEF1W78Lh4nNi5NsXjCZqUE/view)
- ACT template [HERE](https://drive.google.com/file/d/1rsP45OyOsnPYhV8uWYKDAy_spGhjj6aj/view)


--- 

## Sources of exclusion

<br>

College Board and ACT student lists exclude students in two broad ways

1. Generally, only test-takers are included in student list products
  - Test-taking rates differ by race, socioeconomic status, geography
1. "Search filters" allow universities to control which prospects included/excluded from a purchase
  - Relationship between search filters and prospect characteristics is focus of our empirical analyses (report 2)

<br>
Test-optional

- Test-optional movement threatens "coverage" of College Board/ACT student list products
- Number of test-takers will likely decline in future


--- 

## Buying student lists

"Search filters" allow universities to control which prospects included/excluded from a purchase

<br>
Commonly used search filters ([Link to ACT filters](https://helpcenter.encoura.org/hc/en-us/articles/360035260452-Prospect-Search-Filters-))

- Graduation year, HS GPA, test score range, gender, race/ethnicity, geography (e.g., state, zip-code, "geomarket"), intended major

<br>

New filters based on predictive analytics to facilitate micro-targeting ("efficient" name buys of "right fit" students)

- College Board "geodemographic" filters
  - Target prospects based on historical college-going behavior of students at the school/neighborhood
- ACT "enrollment predictor"
  - Target prospects based on their predicted probability of enrolling at your institution

<br>

Policy concerns

- Some search filters disproportionately exclude underrepresented students, especially when used in combination
- Filtering prospects based on the behavior of others (e.g., geodemographic filters)
- More broadly, demand for filters that aid "efficient" name buys is a consequence of names costing so much

--- .subsection

# Market dynamics


--- 

# Shaping the market for student list data
## The five dynamics

1. **Universities and enrollment management consulting firms**
  - Universities are primary customers of student lists, but EM consultancies play central role in buying and using names
<br>    
1. **New data sources, new vendors**
  - Advances in technology created new sources of student list data, leading to market entry by new vendors
<br>    
1. **Acquisitions and concentration**
  - Trend towards competition reversed by rise in acquisitions; EAB enters the student list business
<br>    
1. **Incumbents College Board and ACT seek to retain competitive advantage**
  - Add product features that aid micro-targeting
  - Enter the market for enrollment management consulting
<br>    
1. **The test-optional movement**
  - For-profit firms poised to acquire market share ceded by CB/ACT, and maximize profit by restricting access to names


--- .subsubsection

# Universities and consulting firms
## &nbsp;

Universities need students

- Universities are the primary customers of student list products
- As recruiting became more complex and competitive, universities hire EM consultancies to develop/implement recruiting campaigns

<br>
Enrollment management (EM) consulting firms
- Universities are the primary customers of EM consultancies
- EM firms depend on student list suppliers for two reasons:
  1. Advice/execution of name buys is a core service offered by firms
  1. Names are essential input to predictive models and recruiting interventions firms provide

<br>
Competition in the enrollment management consulting industry

- A mix of large full-service providers (e.g., [Ruffalo Noel Levitz](https://www.ruffalonl.com/)) and small/medium boutique firms (e.g., [Fire Engine Red](https://www.fire-engine-red.com/))
- Anecdotally, market entry in the 2000s
- Over last decade, increase in market concentration due to acquisitions `r citep(bib[c('rogers_2014','wan_2021')])`

--- .subsubsection

# New data sources, new vendors
## &nbsp;

Sources of student list data by late 20th Century

- Standardized assessments
- High school students complete paper survey at school (e.g., College Bound Selection Service (CBSS))

<br>

Advances in technology yield new sources of student list data in the 21st Century

- Data students voluntarily submit online
  - Free college/scholarship search engines (e.g., [scholarships.com](https://www.scholarships.com/), [Niche](https://www.niche.com/colleges/search/best-colleges/), [parchment](https://www.parchment.com/c/college/search/browse/), [Cappex](https://www.cappex.com/))
  - Social network platforms with explicit goal of sharing student profiles with universities they are interested in (e.g., Zinch, [Cirkled In](https://www.cirkledin.com/))
- Software purchased by high schools to help students plan for college
  - e.g., [Naviance](https://www.powerschool.com/solutions/naviance-by-powerschool/), [Scoir](https://www.scoir.com/?hsLang=en-us)
  
<br>

New data sources create opportunities for market entry by new vendors

- Vendors associated with college search engines (e.g., [Cappex](https://www.cappex.com/))
  - Failed market entry by Chegg
- Vendors associated with software used by high schools/students
  - Hobsons acquired Naviance >> PowerSchool acquired Naviance

--- .subsubsection

# Acquisitions and concentration
## Trends in broader EdTech sector

The 2000s were a time of investment and market entry in EdTech, including:

- Entry in enrollment management consulting industry
- Entry by new student list vendors

<br>
In last five years, increase in both investment and acquisitions `r citep(bib['bradley_2021'])`

- Broader EdTech sector becomes more concentrated
- Student list vendors get acquired (e.g., NRCCUA by ACT, Cappex by EAB)
- Enrollment management consulting firms get acquired (e.g., Noel Levitz by Ruffalo, ) `r citep(bib['rogers_2014'])`

<br>
Emergence of large organizations that are simultaneously consultants, software providers, and suppliers of names

- [EAB](https://eab.com/) is an enrollment management consulting firm
  - EAB does not sell lists the way College Board and ACT do
  - By end of 2021, EAB arguably became one of most important suppliers of names


--- 

## EAB enters the student list business

Origins of EAB

- In 1983, Bill Royall founded Royall \& Company to provide direct marketing and fundraising for political campaigns
- By 1995, enrollment management consulting for higher ed became main focus
- In 2015, Royall \& Company was acquired for \$850 million by the the Advisory Board Company (NASDAQ:ABCO)
- In 2017, purchased by Vista Equity partners for \$1.5 billion





--- .subsubsection

# Incumbents seek advantage
## &nbsp;

TEXT

--- .subsubsection

# Test-optional
## &nbsp;

TEXT



--- .section

# Empirical Analyses


---

# Introduction
## Women in STEM prospects

```{r women-in-stem, fig.height = 1.5}
ucsd_income_figure <- ucsd_all_income %>% 
  mutate(
    count_type = recode_factor(
        ord_type,
        'prospect' = 'Prospects',
        'metro' = 'Metro'
    )
  ) %>% 
  ggplot(aes(y = count_type, x = income_2564)) + 
  geom_bar(stat = 'identity', fill = color_palette[[1]], width = 0.8) + 
  geom_text(mapping = aes(label = str_c('$', round(income_2564 / 1000), 'K')), size = 2, hjust = -0.1) +
  scale_x_continuous(expand = expansion(mult = c(0, 0.04)), limits = c(0, 130000)) +
  # scale_y_discrete(expand = expansion(mult = c(0.01, 0.1))) +
  xlab('') + ylab('') +
  guides(fill = guide_legend(reverse = T)) +
  theme(
    # plot.background = element_rect(color = 'gray'),
    # panel.background = element_rect(color = 'red'),
    axis.text.x = element_blank(),
    axis.text.y = element_text(color = '#444444', size = 6, face = 'bold', hjust = 1),
  )

ucsd_race_figure_data <- ucsd_all_race %>% 
  mutate(
    race = recode_factor(
      race,
      'missing' = 'Missing',
      'noresponse' = 'No response',
      'other' = 'Other',
      'tworaces' = 'Multiracial',
      'nativehawaii' = 'NH/PI',
      'amerindian' = 'AI/AN',
      'hispanic' = 'Latinx',
      'black' = 'Black',
      'asian' = 'Asian',
      'white' = 'White'
    ),
    count_type = recode_factor(
        ord_type,
        'prospect' = 'Prospects',
        'metro' = 'Metro'
    )
  )

ucsd_race_figure_totals <- ucsd_all_race_full %>% 
  mutate(
    count_type = recode_factor(
        ord_type,
        'prospect' = 'Prospects',
        'metro' = 'Metro'
    )
  ) %>% 
  group_by(count_type) %>% 
  summarise(
    count = sum(count)
  ) %>% 
  ungroup()
  
ucsd_race_figure <- ucsd_race_figure_data %>% 
  filter(!race %in% c('No response', 'Missing')) %>% 
  ggplot(aes(y = count_type, x = pct, fill = race)) + 
  geom_bar(position = 'stack', stat = 'identity', alpha = alpha_bar, width = 0.8) + 
  geom_text(mapping = aes(label = if_else(pct > 0.02, as.character(round(pct * 100)), '')), size = 2, position = position_stack(vjust = 0.5), color = color_text) +
  geom_text(data = ucsd_race_figure_totals, mapping = aes(x = 1, fill = NULL, label = if_else(count_type == 'Prospects', str_c('N=', prettyNum(count, big.mark = ',')), '')), size = 2, hjust = -0.1) +
  # scale_fill_brewer(palette = 'BrBG', direction = -1, name = 'Race') +
  scale_fill_manual(values = rev(color_gradient[1:7]), name = 'Race') +
  scale_x_continuous(expand = expansion(mult = c(0, 0.04)), limits = c(0, 1.14)) +
  # scale_y_discrete(expand = expansion(mult = c(0.01, 0.1))) +
  xlab('') + ylab('') +
  guides(fill = guide_legend(reverse = T)) +
  theme(
    # plot.background = element_rect(color = 'gray'),
    # panel.background = element_rect(color = 'red'),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    plot.margin = unit(c(5.5, 0, 5.5, 2), 'pt')
  )

grid.arrange(
  ucsd_income_figure,
  ucsd_race_figure,
  ncol = 2,
  widths = c(2, 3)
)
```

Note: <i>Public high schools that satisfied the following criteria were included: enrolls at least ten female 12th graders; is a non-virtual school; is an open, new, or reopened school. Prospects whose race were unknown (`r ucsd_all_race_full_pct[['prospect_missing']]`%) or did not report their race (`r ucsd_all_race_full_pct[['prospect_noresponse']]`%) were excluded.</i>



--- .subsection

# Data collection and research design


--- .subsubsection

# Data collection
## Summary of data received

```{r received-data, results = 'asis', echo = F, message = F}
univ_status %>% 
  filter(state_code != 'MN') %>% 
  mutate(
    not_received_orders = if_else(received_cb_orders == 'N' & received_act_orders == 'N' & received_nrccua_orders == 'N' & received_encoura_orders == 'N', 1, 0), 
    received_orders = if_else(not_received_orders == 1, 0, 1),
    not_received_lists = if_else(received_cb_lists == 'N' & received_act_lists == 'N' & received_nrccua_lists == 'N' & received_encoura_lists == 'N', 1, 0), 
    received_lists = if_else(not_received_lists == 1, 0, 1),
    received_both = if_else(received_orders == 1 & received_lists == 1, 1, 0),
    not_received_both = if_else(received_both == 1, 0, 1)
  ) %>% 
  group_by(state_code) %>% 
  summarise(
    not_received_orders = sum(not_received_orders),
    received_orders = sum(received_orders),
    not_received_lists = sum(not_received_lists),
    received_lists = sum(received_lists),
    received_both = sum(received_both),
    not_received_both = sum(not_received_both)
  ) %>% 
  ungroup() %>% 
  select(state_code, received_orders, not_received_orders, received_lists, not_received_lists, received_both, not_received_both) %>% 
  xtable(align = rep('c', 8), display = c('d', 's', rep('d', 6))) %>% 
  print(add.to.row = list(pos = list(0), command = c('<tr style="text-align:center;"><th>State</th><th># received order summary</th><th># no order summary</th><th># received list</th><th># no list</th><th># received both</th><th># did not receive both</th></tr>')), include.colnames = F)
```


--- .subsubsection

# Research design
## Summary of orders and prospects

```{r purchased-data, results = 'asis', echo = F, message = F}
data.frame(
  orders_total = num_orders,
  orders_with_list = num_orders_w_list,
  prospects_total = prettyNum(num_prospects, ','),
  prospects_with_order = prettyNum(num_prospects_w_order, ',')
) %>% 
  xtable(align = rep('c', 5), display = rep('d', 5)) %>% 
  print(add.to.row = list(pos = list(0), command = c('<tr style="text-align:center;"><th>RQ1</th><th>RQ3</th><th>RQ2</th><th>RQ3</th></tr><tr style="text-align:center;"><th># orders total</th><th># orders with list</th><th># prospects total</th><th># prospects with order</th></tr>')), include.colnames = F)
```


---

## Orders and prospects purchased

```{r orders-prospects-purchased, fig.height = 3.5}
orders_prospects_purchased %>% 
  ggplot(aes(x = total_students, y = reorder(univ_id, total_students), fill = univ_label)) +
  geom_bar(stat = 'identity') +
  geom_text(aes(label = str_c(total_orders, if_else(total_orders == 1, ' order', ' orders'))), hjust = -0.1, size = 2) +
  scale_x_continuous(labels = function(n) if_else(n < 1000000, str_c(n / 1000, 'K'), str_c(n / 1000000, 'M')), breaks = seq(0, 2.6e6, 2e5), expand = expansion(mult = c(0.01, 0.1)), limits = c(0, 2.7e6)) +
  scale_x_break(c(5e5, 2.2e6)) +
  scale_fill_manual(values = color_palette, name = 'University type') +
  xlab('Number of prospects') + ylab('') +
  theme(
    axis.ticks.y = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.x.top = element_blank(),
    axis.text.x.top = element_blank()
  )
```



--- .subsection

# RQ1


--- .subsubsection

# Broad patterns
## Filters used in order purchases

```{r orders-filters, fig.height = 5}
orders_filters %>% 
  add_row(univ_label = 'Research', filters = 'academic', is_asu = 'all', num = 0) %>% 
  add_row(univ_label = 'MA/doctoral', filters = 'academic', is_asu = 'all', num = 0) %>% 
  add_row(univ_label = 'Research', filters = 'geographic', is_asu = 'all', num = 0) %>% 
  add_row(univ_label = 'MA/doctoral', filters = 'geographic', is_asu = 'all', num = 0) %>% 
  add_row(univ_label = 'Research', filters = 'demographic', is_asu = 'all', num = 0) %>% 
  add_row(univ_label = 'MA/doctoral', filters = 'demographic', is_asu = 'all', num = 0) %>% 
  add_row(univ_label = 'Research', filters = 'student preferences', is_asu = 'all', num = 0) %>% 
  add_row(univ_label = 'MA/doctoral', filters = 'student preferences', is_asu = 'all', num = 0) %>% 
  mutate(
    filters_label = recode_factor(
      filters,
      'citizenship' = 'Citizenship',
      'rotc' = 'ROTC',
      'financial_aid' = 'Financial aid',
      'national_recognition_programs' = 'NRP',
      'edu_aspirations' = 'Education aspirations',
      'college_setting' = 'College setting',
      'college_studentbody' = 'College student body',
      'college_living_plans' = 'College living plans',
      'college_location' = 'College location',
      'college_type' = 'College type',
      'major' = 'Major',
      'college_size' = 'College size',
      'student preferences' = '   ',
      'first_gen_parent' = 'First generation',
      'low_ses' = 'Low SES',
      'gender' = 'Gender',
      'race' = 'Race',
      'demographic' = '  ',
      'proximity_search' = 'Proximity search',
      'county' = 'County',
      'intl' = 'International',
      'cbsa' = 'CBSA',
      'segment' = 'Segment',
      'geomarket' = 'Geomarket',
      'zip' = 'Zip code',
      'states_fil' = 'State',
      'geographic' = ' ',
      'hs_math' = 'HS math',
      'sat_reading_writing' = 'SAT reading/writing',
      'sat_reading' = 'SAT reading',
      'sat_writing' = 'SAT writing',
      'sat_math' = 'SAT math',
      'ap_score' = 'AP score',
      'rank' = 'Rank',
      'psat' = 'PSAT',
      'sat' = 'SAT',
      'gpa' = 'GPA',
      'academic' = '',
      'hsgrad_class' = 'HS grad class'
    )
  ) %>% 
  filter(!filters %in% c('hs_math', 'proximity_search', 'rotc', 'citizenship')) %>% 
  ggplot(aes(x = filters_label, y = num, fill = is_asu)) +
  geom_bar(stat = 'identity') +
  geom_text(aes(label = if_else(filters %in% c('academic', 'geographic', 'demographic', 'student preferences') & univ_label == 'Research', str_c(str_to_sentence(filters), ' filters'), ''), y = 0), hjust = 0, vjust = 0.8, size = 2, fontface = 'bold') +
  geom_text(aes(y = num_total, label = if_else(!filters %in% c('academic', 'geographic', 'demographic', 'student preferences') & is_asu != 'asu', str_c(round(pct * 100), '%'), '')), hjust = -0.1, size = 2) +
  scale_y_continuous(expand = expansion(mult = c(0.01, 0.1))) +
  scale_fill_manual(values = rev(color_palette[c(1, 2)]), name = 'ASU') +
  xlab('') + ylab('Number of orders') +
  guides(fill = guide_legend(reverse = T)) +
  facet_wrap(~ factor(univ_label, levels = c('Research', 'MA/doctoral'))) +
  coord_flip() + 
  theme(
    legend.position = 'none'
  )
```


--- .subsubsection

# Academic filters
## GPA filter used

```{r orders-gpa, fig.height = 3}
orders_gpa_total <- orders_gpa %>% 
  group_by(univ_type) %>% 
  summarise(
    num_orders = sum(n_low)
  ) %>% 
  pull(num_orders, univ_type)

orders_gpa %>% 
  mutate(
    univ_label = recode_factor(
      univ_type,
      'research' = str_c('Research (N=', orders_gpa_total[['research']], ')'),
      'regional' = str_c('MA/doctoral (N=', orders_gpa_total[['regional']], ')')
    )
  ) %>% 
  ggplot(aes(x = factor(gpa_low, levels = c('A+', 'A', 'A-', 'B+', 'B', 'B-', 'C+', 'C', 'C-')), y = pct_low, fill = univ_label)) +
  geom_bar(position = 'dodge', stat = 'identity') +
  geom_text(aes(label = n_low), hjust = 0.5, vjust = 0, size = 2, position = position_dodge(0.9)) +
  scale_y_continuous(labels = label_percent(accuracy = 1)) +
  scale_fill_manual(values = color_palette, name = 'University type') +
  xlab('') + ylab('% of orders in university type')
```


---

## SAT filter used


```{r orders-sat, fig.height = 4}
orders_sat_total <- orders_sat %>% 
  filter(test_range == 'sat_min') %>% 
  group_by(univ_type) %>% 
  summarise(
    num_orders = sum(num)
  ) %>% 
  pull(num_orders, univ_type)

orders_sat %>% 
  mutate(
    range_label = recode_factor(
      test_range,
      'sat_min' = 'Minimum',
      'sat_max' = 'Maximum'
    ),
    univ_label = recode_factor(
      univ_type,
      'research' = str_c('Research (N=', orders_sat_total[['research']], ')'),
      'regional' = str_c('MA/doctoral (N=', orders_sat_total[['regional']], ')')
    )
  ) %>% 
  ggplot(aes(x = brks, y = pct, fill = univ_label)) +
  geom_bar(position = position_dodge2(reverse = T, padding = 0), stat = 'identity') +
  geom_text(aes(label = num), hjust = -0.1, size = 2, position = position_dodge2(0.9, reverse = T, padding = 0)) +
  scale_y_continuous(expand = expansion(mult = c(0.01, 0.1)), labels = label_percent(accuracy = 1)) +
  scale_fill_manual(values = color_palette, name = 'University type') +
  xlab('') + ylab('% of orders in university type') +
  facet_wrap(~ range_label) +
  coord_flip()
```


---

## PSAT filter used

```{r orders-psat, fig.height = 4}
orders_psat_total <- orders_psat %>% 
  filter(test_range == 'psat_min') %>% 
  group_by(univ_type) %>% 
  summarise(
    num_orders = sum(num)
  ) %>% 
  pull(num_orders, univ_type)

orders_psat %>% 
  mutate(
    range_label = recode_factor(
      test_range,
      'psat_min' = 'Minimum',
      'psat_max' = 'Maximum'
    ),
    univ_label = recode_factor(
      univ_type,
      'research' = str_c('Research (N=', orders_psat_total[['research']], ')'),
      'regional' = str_c('MA/doctoral (N=', orders_psat_total[['regional']], ')')
    )
  ) %>% 
  ggplot(aes(x = brks, y = pct, fill = univ_label)) +
  geom_bar(position = position_dodge2(reverse = T, padding = 0), stat = 'identity') +
  geom_text(aes(label = num), hjust = -0.1, size = 2, position = position_dodge2(0.9, reverse = T, padding = 0)) +
  scale_y_continuous(expand = expansion(mult = c(0.01, 0.1)), labels = label_percent(accuracy = 1)) +
  scale_fill_manual(values = color_palette, name = 'University type') +
  xlab('') + ylab('% of orders in university type') +
  facet_wrap(~ range_label) +
  coord_flip()
```



--- .subsubsection

#  Geographic filters
## State filter used by research universities, out-of-state

```{r orders-state-research-outofstate, fig.height = 2.8, fig.width = 5}
# Out-of-state
plot_usmap(
  regions = 'states',
  data = orders_state_research %>% filter(locale == 'outofstate'),
  values = 'frequency'
) +
  scale_fill_gradient2(
    low = 'white',
    mid = '#ededed',
    high = 'cyan', 
    midpoint = 35,
    name = 'Number of orders',
    label = label_number(accuracy = 1),
    limits = c(0, 120)
  ) + 
  # labs(title = 'State filter used by research universities (out-of-state)') +
  theme(
    text = element_text(size = 7), 
    panel.background = element_rect(fill = '#f0f0f0', color = NA),
    plot.background = element_rect(fill = '#f0f0f0', color = NA),
    plot.title = element_text(color = '#444444', hjust = 0.5, face = 'bold'), 
    legend.background = element_rect(fill = '#f0f0f0', color = NA),
    legend.title = element_text(face = 'bold'),
    legend.position = 'right'
  )
```

---

## State filter used by research universities, in-state

```{r orders-state-research-instate, fig.height = 2.8, fig.width = 5}
# In-state
plot_usmap(
  regions = 'states',
  data = orders_state_research %>% filter(locale == 'instate'),
  values = 'frequency'
) +
  scale_fill_continuous(
    low = '#ededed',
    high = 'cyan', 
    name = 'Number of orders',
    label = label_number(accuracy = 1),
    limits = c(0, 10)
  ) + 
  # labs(title = 'State filter used by research universities (in-state)') +
  theme(
    text = element_text(size = 7), 
    panel.background = element_rect(fill = '#f0f0f0', color = NA),
    plot.background = element_rect(fill = '#f0f0f0', color = NA),
    plot.title = element_text(color = '#444444', hjust = 0.5, face = 'bold'), 
    legend.background = element_rect(fill = '#f0f0f0', color = NA),
    legend.title = element_text(face = 'bold'),
    legend.position = 'right'
  )
```


--- .subsubsection

# Demographic filters
## Race filter

```{r orders-race, fig.height = 3}
orders_race %>% 
  ggplot(aes(fill = univ_label, y = count, x = reorder(race_ethnicity_group, count))) + 
  geom_bar(position = 'stack', stat = 'identity') +
  geom_text(aes(label = count), hjust = -0.1, size = 2) +
  scale_fill_manual(values = color_palette, name = 'University type') +
  scale_y_continuous(expand = expansion(mult = c(0.01, 0.1))) +
  xlab('') + ylab('Number of orders') +
  coord_flip()
```


--- .subsubsection

# Combination of filters
## Filter combos used in order purchases

```{r orders-filters-combo, results = 'asis'}
bind_cols(
  orders_filters_combo %>% 
    filter(univ_type == 'research') %>% 
    select(filter_combos, n, pct) %>% 
    head(10) %>%
    mutate(pct = str_c(round(pct * 100), '%')),
  orders_filters_combo %>% 
    filter(univ_type == 'regional') %>% 
    select(filter_combos, n, pct) %>% 
    head(10) %>%
    mutate(pct = str_c(round(pct * 100), '%'))
) %>% 
  xtable(align = c('c', 'p', 'c', 'c', 'p', 'c', 'c'), display = c('d', 's', 'd', 's', 's', 'd', 's')) %>% 
  print(add.to.row = list(pos = list(0), command = c('<tr><th colspan="3" style="text-align:center;">Research</th><th colspan="3" style="text-align:center;">MA/doctoral</th></tr><tr><th>Filters</th><th>Count</th><th>Percent</th><th>Filters</th><th>Count</th><th>Percent</th></tr>')), include.colnames = F)
```


--- .subsection

# RQ2


---

# Characteristics of Prospects
## Number of prospects by university type and location

```{r rq2-counts, fig.height = 3}
rq2_counts %>% 
  mutate(
    region = recode_factor(
      region,
      'international' = 'International',
      'domestic' = 'Domesetic'
    ),
    count_type = str_c(univ_type, locale, sep = '_'),
    count_type = recode_factor(
      count_type,
      'regional_outofstate' = 'MA/doctoral (out-of-state)',
      'regional_instate' = 'MA/doctoral (in-state)',
      'research_outofstate' = 'Research (out-of-state)',
      'research_instate' = 'Research (in-state)'
    )
  ) %>% 
  ggplot(aes(y = count_type, x = n, fill = region)) + 
  geom_bar(position = 'stack', stat = 'identity') + 
  geom_text(mapping = aes(label = if_else(univ_type == 'regional' & locale == 'outofstate', '', if_else(n < 1000000, str_c(round(n / 1000), 'K'), str_c(round(n / 1000000, 1), 'M')))), size = 2, position = position_stack(vjust = 0.5)) +
  geom_text(mapping = aes(label = if_else(univ_type == 'regional' & region == 'Domesetic' & locale == 'outofstate', str_c(round(n / 1000), 'K (300 international)'), ''), x = 30e3), hjust = 0, size = 2) +
  scale_fill_manual(values = rev(color_palette[1:2]), name = '') +
  scale_x_continuous(expand = expansion(mult = c(0, 0.04)), labels = function(n) if_else(n < 1000000, str_c(n / 1000, 'K'), str_c(n / 1000000, 'M'))) +
  xlab('Number of prospects') + ylab('') +
  guides(fill = guide_legend(reverse = T)) +
  theme(
    axis.text.y = element_text(color = '#444444', size = 7, face = 'bold', hjust = 1)
  )
```



--- .subsubsection

# Public research universities 
## Racial composition of prospects in lists purchased

```{r rq2-race-research, fig.height = 2}
rq2_race %>% 
  filter(univ_type == 'research', region != 'international') %>% 
  mutate(
    stu_race_cb = if_else(is.na(stu_race_cb), 999, unclass(stu_race_cb)),
    race = recode_factor(
      stu_race_cb,
      `999` = 'Missing',
      `0` = 'No response',
      `10` = 'Other',
      `12` = 'Multiracial',
      `8` = 'NH/PI',
      `1` = 'AI/AN',
      `4` = 'Latinx',
      `3` = 'Black',
      `2` = 'Asian',
      `9` = 'White'
    ),
    count_type = str_c(univ_type, locale, sep = '_'),
    count_type = recode_factor(
      count_type,
      'research_outofstate' = 'Research (out-of-state)',
      'research_instate' = 'Research (in-state)'
    )
  ) %>% 
  filter(race != 'Missing') %>% 
  ggplot(aes(y = count_type, x = pct, fill = race)) + 
  geom_bar(position = 'stack', stat = 'identity', alpha = alpha_bar) + 
  geom_text(mapping = aes(label = if_else(pct > 0.02, as.character(round(pct * 100)), '')), size = 2, position = position_stack(vjust = 0.5), color = color_text) +
  # scale_fill_brewer(palette = 'BrBG', direction = -1, name = 'Race') +
  scale_fill_manual(values = rev(color_gradient), name = 'Race') +
  scale_x_continuous(expand = expansion(mult = c(0, 0.04))) +
  scale_y_discrete(expand = expansion(mult = c(0.01, 0.1))) +
  xlab('Percent of prospects') + ylab('') +
  guides(fill = guide_legend(reverse = T)) +
  theme(
    axis.text.x = element_blank(),
    axis.text.y = element_text(color = '#444444', size = 7, face = 'bold', hjust = 1)
  )
```


---

## Median household income of prospects in lists purchased

```{r rq2-income-research, fig.height = 1.5}
rq2_income %>% 
  filter(univ_type == 'research', region != 'international') %>% 
  mutate(
    count_type = str_c(univ_type, locale, sep = '_'),
    count_type = recode_factor(
      count_type,
      'research_outofstate' = 'Research (out-of-state)',
      'research_instate' = 'Research (in-state)'
    )
  ) %>% 
  ggplot(aes(y = count_type, x = income_2564)) + 
  geom_bar(stat = 'identity', fill = color_palette[[1]]) + 
  geom_text(mapping = aes(label = str_c('$', round(income_2564 / 1000), 'K')), size = 2, hjust = -0.1) +
  scale_x_continuous(expand = expansion(mult = c(0, 0.04)), limits = c(0, 115000)) +
  scale_y_discrete(expand = expansion(mult = c(0.01, 0.1))) +
  xlab('') + ylab('') +
  guides(fill = guide_legend(reverse = T)) +
  theme(
    axis.text.x = element_blank(),
    axis.text.y = element_text(color = '#444444', size = 7, face = 'bold', hjust = 1)
  )
```


---

## Locale of prospects in lists purchased

```{r rq2-locale-research, fig.height = 2}
rq2_locale %>% 
  filter(univ_type == 'research', region != 'international') %>% 
  mutate(
    count_type = str_c(univ_type, locale, sep = '_'),
    count_type = recode_factor(
      count_type,
      'research_outofstate' = 'Research (out-of-state)',
      'research_instate' = 'Research (in-state)'
    )
  ) %>% 
  ggplot(aes(y = count_type, x = pct, fill = locale_text)) + 
  geom_bar(position = 'stack', stat = 'identity', alpha = alpha_bar) + 
  geom_text(mapping = aes(label = if_else(pct > 0.02, as.character(round(pct * 100)), '')), size = 2, position = position_stack(vjust = 0.5), color = color_text) +
  # scale_fill_brewer(palette = 'BrBG', direction = -1, name = 'Locale') +
  scale_fill_manual(values = rev(color_gradient[1:7]), name = 'Locale') +
  scale_x_continuous(expand = expansion(mult = c(0, 0.04))) +
  scale_y_discrete(expand = expansion(mult = c(0.01, 0.1))) +
  xlab('Percent of prospects') + ylab('') +
  guides(fill = guide_legend(reverse = T)) +
  theme(
    axis.text.x = element_blank(),
    axis.text.y = element_text(color = '#444444', size = 7, face = 'bold', hjust = 1)
  )
```


--- .subsubsection

# Public ma/doctoral universities
## Racial composition of prospects in lists purchased

```{r rq2-race-regional, fig.height = 2}
rq2_race %>% 
  filter(locale == 'instate', region != 'international') %>% 
  mutate(
    stu_race_cb = if_else(is.na(stu_race_cb), 999, unclass(stu_race_cb)),
    race = recode_factor(
      stu_race_cb,
      `999` = 'Missing',
      `0` = 'No response',
      `10` = 'Other',
      `12` = 'Multiracial',
      `8` = 'NH/PI',
      `1` = 'AI/AN',
      `4` = 'Latinx',
      `3` = 'Black',
      `2` = 'Asian',
      `9` = 'White'
    ),
    count_type = str_c(univ_type, locale, sep = '_'),
    count_type = recode_factor(
      count_type,
      'research_instate' = 'Research (in-state)',
      'regional_instate' = 'MA/doctoral (in-state)'
    )
  ) %>% 
  filter(race != 'Missing') %>% 
  ggplot(aes(y = count_type, x = pct, fill = race)) + 
  geom_bar(position = 'stack', stat = 'identity', alpha = alpha_bar) + 
  geom_text(mapping = aes(label = if_else(pct > 0.02, as.character(round(pct * 100)), '')), size = 2, position = position_stack(vjust = 0.5), color = color_text) +
  # scale_fill_brewer(palette = 'BrBG', direction = -1, name = 'Race') +
  scale_fill_manual(values = rev(color_gradient), name = 'Race') +
  scale_x_continuous(expand = expansion(mult = c(0, 0.04))) +
  scale_y_discrete(expand = expansion(mult = c(0.01, 0.1))) +
  xlab('Percent of prospects') + ylab('') +
  guides(fill = guide_legend(reverse = T)) +
  theme(
    axis.text.x = element_blank(),
    axis.text.y = element_text(color = '#444444', size = 7, face = 'bold', hjust = 1)
  )
```


---

## Median household income of prospects purchased

```{r rq2-income-regional, fig.height = 2}
rq2_income %>% 
  filter(locale == 'instate', region != 'international') %>% 
  mutate(
    count_type = str_c(univ_type, locale, sep = '_'),
    count_type = recode_factor(
      count_type,
      'research_instate' = 'Research (in-state)',
      'regional_instate' = 'MA/doctoral (in-state)'
    )
  ) %>% 
  ggplot(aes(y = count_type, x = income_2564)) + 
  geom_bar(stat = 'identity', fill = color_palette[[1]]) + 
  geom_text(mapping = aes(label = str_c('$', round(income_2564 / 1000), 'K')), size = 2, hjust = -0.1) +
  scale_x_continuous(expand = expansion(mult = c(0, 0.04)), limits = c(0, 105000)) +
  scale_y_discrete(expand = expansion(mult = c(0.01, 0.1))) +
  xlab('') + ylab('') +
  guides(fill = guide_legend(reverse = T)) +
  theme(
    axis.text.x = element_blank(),
    axis.text.y = element_text(color = '#444444', size = 7, face = 'bold', hjust = 1)
  )
```


---

## Locale of prospects in lists purchased

```{r rq2-locale-regional, fig.height = 2}
rq2_locale %>% 
  filter(locale == 'instate', region != 'international') %>% 
  mutate(
    count_type = str_c(univ_type, locale, sep = '_'),
    count_type = recode_factor(
      count_type,
      'research_instate' = 'Research (in-state)',
      'regional_instate' = 'MA/doctoral (in-state)'
    )
  ) %>% 
  ggplot(aes(y = count_type, x = pct, fill = locale_text)) + 
  geom_bar(position = 'stack', stat = 'identity', alpha = alpha_bar) + 
  geom_text(mapping = aes(label = if_else(pct > 0.02, as.character(round(pct * 100)), '')), size = 2, position = position_stack(vjust = 0.5), color = color_text) +
  # scale_fill_brewer(palette = 'BrBG', direction = -1, name = 'Locale') +
  scale_fill_manual(values = rev(color_gradient[1:7]), name = 'Locale') +
  scale_x_continuous(expand = expansion(mult = c(0, 0.04))) +
  scale_y_discrete(expand = expansion(mult = c(0.01, 0.1))) +
  xlab('Percent of prospects') + ylab('') +
  guides(fill = guide_legend(reverse = T)) +
  theme(
    axis.text.x = element_blank(),
    axis.text.y = element_text(color = '#444444', size = 7, face = 'bold', hjust = 1)
  )
```


--- .subsection

# RQ3


--- .subsubsection

# Characteristics by filters
## Prospect characteristics across individual filter criteria

```{r rq3, results = 'asis'}
rq3 %>% 
  mutate_if(is.numeric, ~if_else(. < 1, . * 100, .)) %>% 
  mutate_if(is.numeric, round, 0) %>% 
  mutate_if(is.numeric, ~if_else(row_number() == 18, str_c('$', round(. / 1000), 'K'), prettyNum(., big.mark = ','))) %>% 
  mutate(
    row_subj = recode_factor(
      row_subj,
      'n' = ' ',
      'pct_instate' = '% In-state',
      'pct_outofstate' = '% Out-of-state',
      'pct_white' = '% White',
      'pct_asian' = '% Asian',
      'pct_black' = '% Black',
      'pct_latinx' = '% Latinx',
      'pct_aian' = '% AI/AN',
      'pct_nhpi' = '% NH/PI',
      'pct_multiracial' = '% Multiracial',
      'pct_raceother' = '% Other',
      'pct_noresponse' = '% No response',
      'pct_racemissing' = '% Missing',
      'pct_male' = '% Male',
      'pct_female' = '% Female',
      'pct_genderother' = '% Other ',
      'pct_gendermissing' = '% Missing ',
      'med_income' = 'Median income',
      'pct_city' = '% City',
      'pct_suburban' = '% Suburban',
      'pct_fringe' = '% Rural - Fringe',
      'pct_distant' = '% Rural - Distant',
      'pct_remote' = '% Rural - Remote',
      'pct_localemissing' = '% Missing  '
    )
  ) %>%
  arrange(row_subj) %>% 
  add_column('x1' = if_else(.$row_subj == ' ', 'Total', ' '), .before = 'row_subj') %>% 
  add_column('x2' = ' ', .before = 'filter_zip') %>% 
  add_column('x3' = ' ', .before = 'filter_race') %>% 
  xtable(align = c('c', 'l', 'l', rep('c', 15))) %>% 
  print(
    html.table.attributes = 'style="font-size:10px;"',
    add.to.row = list(
      pos = list(0, 1, 3, 13, 17, 18),
      command = c('<tr style="text-align: center;"><th colspan="3" style="border-bottom: none;"></th><th colspan="5">Academic</th><th style="border-bottom: none;"><th colspan="5">Geographic</th><th style="border-bottom: none;"></th><th colspan="2">Demographic</th></tr><tr style="text-align:center;"><th width="15px;"></th><th></th><th>All domestic</th><th>GPA</th><th>PSAT</th><th>SAT</th><th>HS rank</th><th>AP score</th><th width="5px;"></th><th>Zip code</th><th>State</th><th>Geomarket</th><th>Segment</th><th>CBSA</th><th width="5px;"></th><th>Race</th><th>Gender</th></tr>', '<tr style="font-weight:900"><td colspan="2">Location</td></tr>', '<tr style="font-weight:900"><td colspan="2">Race/ethnicity</td></tr>', '<tr style="font-weight:900"><td colspan="2">Gender</td></tr>', '<tr style="font-weight:900"><td colspan="2">Household income</td></tr>', '<tr style="font-weight:900"><td colspan="2">Locale</td></tr>')
    ),
    include.colnames = F
  )
```


--- .subsubsection

# Zip code & test score filters
## Los Angeles prospects from top income decile zip codes

```{r asu-la-deep-dive, fig.height = 3}
asu_la_figure_totals <- asu_la_full %>% 
  mutate(
    count_type = recode_factor(
      in_zip_top10pct,
      `0` = 'Rest',
      `1` = 'Top 10%'
    ),
    ord_type = recode_factor(
      ord_type,
      'psat_high' = 'High PSAT order (1270-1520)',
      'psat_med' = 'Medium PSAT order (1190-1260)',
      'psat_low' = 'Low PSAT order (1110-1210)',
      'sat_med' = 'Medium SAT order (1140-1260)'
    )
  ) %>% 
  group_by(ord_type, count_type) %>% 
  summarise(
    count = sum(count)
  ) %>% 
  ungroup()

asu_la %>% 
  mutate(
    stu_race_cb = if_else(is.na(stu_race_cb), 999, unclass(stu_race_cb)),
    race = recode_factor(
      stu_race_cb,
      `999` = 'Missing',
      `0` = 'No response',
      `10` = 'Other',
      `12` = 'Multiracial',
      `8` = 'NH/PI',
      `1` = 'AI/AN',
      `4` = 'Latinx',
      `3` = 'Black',
      `2` = 'Asian',
      `9` = 'White'
    ),
    count_type = recode_factor(
      in_zip_top10pct,
      `0` = 'Rest',
      `1` = 'Top 10%'
    ),
    ord_type = recode_factor(
      ord_type,
      'psat_high' = 'High PSAT order (1270-1520)',
      'psat_med' = 'Medium PSAT order (1190-1260)',
      'psat_low' = 'Low PSAT order (1110-1210)',
      'sat_med' = 'Medium SAT order (1140-1260)'
    )
  ) %>% 
  filter(!race %in% c('Missing', 'No response')) %>% 
  ggplot(aes(y = count_type, x = pct, fill = race)) + 
  geom_bar(position = 'stack', stat = 'identity', alpha = alpha_bar) + 
  geom_text(mapping = aes(label = if_else(pct > 0.02, as.character(round(pct * 100)), '')), size = 2, position = position_stack(vjust = 0.5), color = color_text) +
  geom_text(data = asu_la_figure_totals, mapping = aes(x = 1, fill = NULL, label = str_c('N=', prettyNum(count, ','))), size = 2, hjust = -0.1) +
  # scale_fill_brewer(palette = 'BrBG', direction = -1, name = 'Race') +
  scale_fill_manual(values = rev(color_gradient[1:7]), name = 'Race') +
  scale_x_continuous(expand = expansion(mult = c(0, 0.04)), limits = c(0, 1.15)) +
  scale_y_discrete(expand = expansion(mult = c(0.01, 0.1))) +
  xlab('Percent of prospects') + ylab('') +
  facet_wrap(~ ord_type) +
  guides(fill = guide_legend(reverse = T)) +
  theme(
    axis.text.x = element_blank(),
    axis.text.y = element_text(color = '#444444', size = 6, face = 'bold', hjust = 1)
  )
```



--- .subsubsection

# Geodemographic segment filters
## Filter by neighborhood segments

```{r orders-cluster-en, results = 'asis'}
en_df <- data.frame(
  cluster = c(51:83, 'Total'),
  sat_math = c(546, 480, 561, 458, 566, 420, 541, 533, 561, 589, 585, 596, 548, 466, 440, 499, 519, 552, 534, 613, 405, 399, 528, 433, 459, 514, 502, 594, 550, 534, 491, 496, 500, 512),
  sat_cr = c(533, 470, 544, 443, 565, 411, 519, 489, 562, 590, 567, 595, 541, 466, 433, 492, 501, 558, 521, 598, 408, 397, 514, 435, 457, 509, 492, 578, 551, 527, 483, 491, 490, 502),
  pct_outofstate = c(0.32, 0.3, 0.32, 0.25, 0.52, 0.29, 0.52, 0.28, 0.52, 0.63, 0.51, 0.67, 0.39, 0.48, 0.23, 0.2, 0.27, 0.52, 0.37, 0.65, 0.39, 0.31, 0.29, 0.29, 0.28, 0.27, 0.26, 0.56, 0.57, 0.39, 0.27, 0.29, 0.19, 0.32),
  pct_nonwhite = c(0.3, 0.58, 0.5, 0.83, 0.24, 0.93, 0.47, 0.87, 0.24, 0.37, 0.3, 0.24, 0.23, 0.34, 0.93, 0.12, 0.53, 0.35, 0.19, 0.29, 0.97, 0.87, 0.42, 0.84, 0.85, 0.38, 0.18, 0.26, 0.32, 0.39, 0.57, 0.21, 0.26, 0.43),
  pct_aid = c(0.57, 0.71, 0.55, 0.76, 0.63, 0.66, 0.43, 0.69, 0.74, 0.36, 0.4, 0.72, 0.65, 0.29, 0.78, 0.76, 0.59, 0.65, 0.65, 0.61, 0.68, 0.47, 0.62, 0.79, 0.72, 0.64, 0.75, 0.39, 0.74, 0.65, 0.72, 0.75, 0.71, 0.65),
  med_income = c(95432, 63578, 92581, 38977, 71576, 35308, 67394, 68213, 54750, 104174, 123858, 59824, 69347, 49829, 45081, 50453, 60960, 57902, 88100, 86381, 42661, 32708, 90849, 44065, 50421, 61332, 62372, 134400, 40909, 49877, 63030, 53465, 49335, 70231)
) %>% 
  mutate(
    pct_outofstate = percent(pct_outofstate, accuracy = 1),
    pct_nonwhite = percent(pct_nonwhite, accuracy = 1),
    pct_aid = percent(pct_aid, accuracy = 1),
    med_income = dollar(med_income)
  ) %>% 
  xtable(align = c('l', 'l', rep('c', 6))) %>% 
  print(type = 'html', html.table.attributes = 'style="font-size:10px;" id="cluster-en"', add.to.row = list(
      pos = list(0),
      command = c('<tr style="text-align:center;"><th style="text-align:left;">2011 D+ Cluster</th><th>SAT Math</th><th>SAT CR</th><th>Going Out of State</th><th>Percent NonWhite</th><th>Need Financial Aid</th><th>Med Income</th></tr>')),
      include.colnames = F
  )
```


---

## Filter by high school segments

```{r orders-cluster-hs, results = 'asis'}
hs_df <- data.frame(
  cluster = c(51:79, 'Total'),
  sat_math = c(462, 489, 471, 376, 489, 536, 434, 592, 499, 523, 485, 474, 440, 606, 515, 498, 526, 541, 390, 595, 400, 528, 451, 654, 514, 600, 595, 473, 594, 514),
  sat_cr = c(457, 496, 484, 371, 481, 508, 435, 577, 489, 549, 370, 473, 427, 542, 503, 515, 546, 540, 395, 581, 412, 544, 438, 579, 502, 584, 508, 468, 585, 502),
  pct_outofstate = c(0.14, 0.81, 0.28, 0.33, 0.39, 0.73, 0.29, 0.51, 0.19, 0.23, 0.33, 0.34, 0.28, 0.37, 0.28, 0.37, 0.48, 0.41, 0.36, 0.56, 0.57, 0.35, 0.24, 0.76, 0.31, 0.72, 0.64, 0.48, 0.61, 0.32),
  pct_nonwhite = c(0.33, 0.99, 0.38, 0.96, 0.46, 0.43, 0.82, 0.27, 0.18, 0.3, 0.89, 0.92, 0.86, 0.89, 0.43, 0.37, 0.41, 0.26, 0.92, 0.33, 0.98, 0.25, 0.89, 0.8, 0.2, 0.5, 0.75, 0.43, 0.26, 0.44),
  pct_aid = c(0.68, 0.77, 0.62, 0.38, 0.44, 0.49, 0.79, 0.32, 0.74, 0.33, 0.09, 0.67, 0.72, 0.57, 0.65, 0.73, 0.69, 0.62, 0.74, 0.48, 0.8, 0.64, 0.76, 0.46, 0.71, 0.28, 0.39, 0.22, 0.71, 0.65),
  med_income = c(40918, 64730, 60833, 38146, 71845, 63967, 48301, 104509, 47685, 70175, 61385, 55515, 49238, 81911, 72692, 60272, 71279, 79260, 43391, 105721, 43137, 70018, 48406, 59089, 72850, 90265, 39490, 56703, 65180, 70223)
) %>% 
  mutate(
    pct_outofstate = percent(pct_outofstate, accuracy = 1),
    pct_nonwhite = percent(pct_nonwhite, accuracy = 1),
    pct_aid = percent(pct_aid, accuracy = 1),
    med_income = dollar(med_income)
  ) %>% 
  xtable(align = c('l', 'l', rep('c', 6))) %>% 
  print(type = 'html', html.table.attributes = 'style="font-size:10px;" id="cluster-hs"', add.to.row = list(
      pos = list(0),
      command = c('<tr style="text-align:center;"><th style="text-align:left;">2011 D+ Cluster</th><th>SAT Math</th><th>SAT CR</th><th>Going Out of State</th><th>Percent NonWhite</th><th>Need Financial Aid</th><th>Med Income</th></tr>')),
      include.colnames = F
  )
```


---

## Segment filter prospects by metro

```{r uiuc-deep-dive, fig.height = 3.6}
uiuc_income_figure <- uiuc_income %>% 
  mutate(
    count_type = recode_factor(
      ord_type,
      'prospect' = 'Prospects',
      'metro' = 'Metro'
    ),
    cbsa_name = str_replace(cbsa_name, ' Metro Area', '')
  ) %>% 
  ggplot(aes(y = count_type, x = income_2564)) + 
  geom_bar(stat = 'identity', fill = color_palette[[1]]) + 
  geom_text(mapping = aes(label = str_c('$', round(income_2564 / 1000), 'K')), size = 2, hjust = -0.1) +
  scale_x_continuous(expand = expansion(mult = c(0, 0.04)), limits = c(0, 250000)) +
  scale_y_discrete(expand = expansion(mult = c(0.01, 0.1))) +
  xlab('') + ylab('') +
  facet_wrap(~ factor(cbsa_name, levels = c('New York-Newark-Jersey City, NY-NJ-PA', 'Los Angeles-Long Beach-Anaheim, CA', 'Philadelphia-Camden-Wilmington, PA-NJ-DE-MD', 'Washington-Arlington-Alexandria, DC-VA-MD-WV')), ncol = 1) +
  guides(fill = guide_legend(reverse = T)) +
  theme(
    # plot.background = element_rect(color = 'gray'),
    # panel.background = element_rect(color = 'red'),
    axis.text.x = element_blank(),
    axis.text.y = element_text(color = '#444444', size = 6, face = 'bold', hjust = 1),
    strip.text.x = element_text(size = 7, face = 'bold', hjust = 0, margin = margin(2, 0, 2, 0, 'mm'))
  )

uiuc_race_figure_data <- uiuc_race %>% 
  mutate(
    race = recode_factor(
      race,
      'unknown' = 'Missing',
      'noresponse' = 'No response',
      'other' = 'Other',
      'tworaces' = 'Multiracial',
      'nativehawaii' = 'NH/PI',
      'amerindian' = 'AI/AN',
      'hispanic' = 'Latinx',
      'black' = 'Black',
      'asian' = 'Asian',
      'white' = 'White'
    ),
    count_type = recode_factor(
      ord_type,
      'prospect' = 'Prospects',
      'metro' = 'Metro'
    ),
    cbsa_name = str_replace(cbsa_name, ' Metro Area', '')
  ) 

uiuc_race_figure_totals <- uiuc_race_full %>% 
  mutate(
    count_type = recode_factor(
        ord_type,
        'prospect' = 'Prospects',
        'metro' = 'Metro'
    )
  ) %>% 
  group_by(cbsa_name, count_type) %>% 
  summarise(
    count = sum(count)
  ) %>% 
  ungroup()
  
uiuc_race_figure <- uiuc_race_figure_data %>% 
  filter(!race %in% c('Missing', 'No response')) %>% 
  ggplot(aes(y = count_type, x = pct, fill = race)) + 
  geom_bar(position = 'stack', stat = 'identity', alpha = alpha_bar) + 
  geom_text(mapping = aes(label = if_else(pct > 0.02, as.character(round(pct * 100)), '')), size = 2, position = position_stack(vjust = 0.5), color = color_text) +
  geom_text(data = uiuc_race_figure_totals, mapping = aes(x = 1, fill = NULL, label = if_else(count_type != 'Metro', str_c('N=', prettyNum(count, big.mark = ',')), '')), size = 2, hjust = -0.15) +
  # scale_fill_brewer(palette = 'BrBG', direction = -1, name = 'Race') +
  scale_fill_manual(values = rev(color_gradient[1:7]), name = 'Race') +
  scale_x_continuous(expand = expansion(mult = c(0, 0.04)), limits = c(0, 1.14)) +
  scale_y_discrete(expand = expansion(mult = c(0.01, 0.1))) +
  xlab('') + ylab('') +
  facet_wrap(~ factor(cbsa_name, levels = c('New York-Newark-Jersey City, NY-NJ-PA', 'Los Angeles-Long Beach-Anaheim, CA', 'Philadelphia-Camden-Wilmington, PA-NJ-DE-MD', 'Washington-Arlington-Alexandria, DC-VA-MD-WV')), ncol = 1) +
  guides(fill = guide_legend(reverse = T)) +
  theme(
    # plot.background = element_rect(color = 'gray'),
    # panel.background = element_rect(color = 'red'),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    strip.text.x = element_text(color = NA, size = 7, face = 'bold', hjust = 0, margin = margin(2, 0, 2, 0, 'mm')),
    plot.margin = unit(c(5.5, 0, 5.5, -45), 'pt')
  )

grid.arrange(
  uiuc_income_figure,
  uiuc_race_figure,
  ncol = 2
)
```


---

## Segment filter prospects interactive map

<iframe src="https://mpatricia01.github.io/public_requests_eda/outputs/maps/map_segment.html" id="uiuc-deep-dive-map" width=100% height=100% allowtransparency="true"></iframe>


--- .subsubsection

# Women in STEM
## Women in STEM prospects by metro

```{r ucsd-deep-dive, fig.height = 4}
ucsd_income_figure <- ucsd_income %>% 
  mutate(
    count_type = recode_factor(
      ord_type,
      'sat' = 'SAT',
      'ap' = 'AP',
      'metro' = 'Metro'
    ),
    cbsa_name = str_replace(str_replace(cbsa_name, 'Roswell', 'Alpharetta'), ' Metro Area', '')
  ) %>% 
  ggplot(aes(y = count_type, x = income_2564)) + 
  geom_bar(stat = 'identity', fill = color_palette[[1]]) + 
  geom_text(mapping = aes(label = str_c('$', round(income_2564 / 1000), 'K')), size = 2, hjust = -0.1) +
  scale_x_continuous(expand = expansion(mult = c(0, 0.04)), limits = c(0, 163000)) +
  scale_y_discrete(expand = expansion(mult = c(0.01, 0.1))) +
  xlab('') + ylab('') +
  facet_wrap(~ cbsa_name, ncol = 1) +
  guides(fill = guide_legend(reverse = T)) +
  theme(
    # plot.background = element_rect(color = 'gray'),
    # panel.background = element_rect(color = 'red'),
    axis.text.x = element_blank(),
    axis.text.y = element_text(color = '#444444', size = 6, face = 'bold', hjust = 1),
    strip.text.x = element_text(size = 7, face = 'bold', hjust = 0, margin = margin(2, 0, 2, 0, 'mm'))
  )

ucsd_race_figure_data <- ucsd_race %>% 
  mutate(
    race = recode_factor(
      race,
      'missing' = 'Missing',
      'noresponse' = 'No response',
      'other' = 'Other',
      'tworaces' = 'Multiracial',
      'nativehawaii' = 'NH/PI',
      'amerindian' = 'AI/AN',
      'hispanic' = 'Latinx',
      'black' = 'Black',
      'asian' = 'Asian',
      'white' = 'White'
    ),
    count_type = recode_factor(
      ord_type,
      'sat' = 'SAT',
      'ap' = 'AP',
      'metro' = 'Metro'
    ),
    cbsa_name = str_replace(cbsa_name, ' Metro Area', '')
  )

ucsd_race_figure_totals <- ucsd_race_full %>% 
  mutate(
    count_type = recode_factor(
      ord_type,
      'sat' = 'SAT',
      'ap' = 'AP',
      'metro' = 'Metro'
    )
  ) %>% 
  group_by(cbsa_name, count_type) %>% 
  summarise(
    count = sum(count)
  ) %>% 
  ungroup()
  
ucsd_race_figure <- ucsd_race_figure_data %>% 
  filter(!race %in% c('Missing', 'No response')) %>% 
  ggplot(aes(y = count_type, x = pct, fill = race)) + 
  geom_bar(position = 'stack', stat = 'identity', alpha = alpha_bar) + 
  geom_text(mapping = aes(label = if_else(pct > 0.02, as.character(round(pct * 100)), '')), size = 2, position = position_stack(vjust = 0.5), color = color_text) +
  geom_text(data = ucsd_race_figure_totals, mapping = aes(x = 1, fill = NULL, label = if_else(count_type != 'Metro', str_c('N=', count), '')), size = 2, hjust = -0.2) +
  # scale_fill_brewer(palette = 'BrBG', direction = -1, name = 'Race') +
  scale_fill_manual(values = rev(color_gradient[1:7]), name = 'Race') +
  scale_x_continuous(expand = expansion(mult = c(0, 0.04)), limits = c(0, 1.14)) +
  scale_y_discrete(expand = expansion(mult = c(0.01, 0.1))) +
  xlab('') + ylab('') +
  facet_wrap(~ cbsa_name, ncol = 1) +
  guides(fill = guide_legend(reverse = T)) +
  theme(
    # plot.background = element_rect(color = 'gray'),
    # panel.background = element_rect(color = 'red'),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    strip.text.x = element_text(color = NA, size = 7, face = 'bold', hjust = 0, margin = margin(2, 0, 2, 0, 'mm')),
    plot.margin = unit(c(5.5, 0, 5.5, 2), 'pt')
  )

grid.arrange(
  ucsd_income_figure,
  ucsd_race_figure,
  ncol = 2,
  widths = c(2, 3)
)
```


--- .subsubsection

# Targeting URM students
## Race and ethnicity variables, aggregated vs. alone

```{r poc-race-deep-dive, fig.height = 4.5}
poc_cb_totals <- poc_cb %>%
  group_by(cbsa_code) %>% 
  summarise(total = sum(count)) %>% 
  ungroup()

poc_cb_figure <- poc_cb %>% 
  left_join(poc_cb_totals, by = 'cbsa_code') %>% 
  mutate(
    race = recode_factor(
      race,
      'unknown' = 'Missing',
      'noresponse' = 'No response',
      'other' = 'Other',
      'tworaces' = 'Multiracial',
      'nativehawaii' = 'NH/PI',
      'amerindian' = 'AI/AN',
      'black' = 'Black',
      'asian' = 'Asian',
      'white' = 'White',
      'hispanic' = 'Latinx'
    ),
    cbsa_name = str_c(cbsa_name, ' (N=', total, ')')
  ) %>% 
  ggplot(aes(x = race, y = pct)) +
  geom_bar(stat = 'identity', fill = color_palette[[1]]) +
  geom_text(aes(label = str_c(round(pct * 100), '%')), hjust = -0.1, size = 2) +
  scale_y_continuous(expand = expansion(mult = c(0.01, 0.1)), limits = c(0, 1)) +
  xlab('') + ylab('') +
  facet_wrap(~ factor(cbsa_name, levels = c('New York-Newark-Jersey City, NY-NJ-PA (N=949)', 'Miami-Fort Lauderdale-West Palm Beach, FL (N=671)', 'Houston-The Woodlands-Sugar Land, TX (N=371)')), ncol = 1) +
  coord_flip() +
  theme(
    axis.text.x = element_blank(),
    axis.text.y = element_text(color = '#444444', size = 6, face = 'bold', hjust = 1),
    strip.text.x = element_text(size = 7, face = 'bold', hjust = 0, margin = margin(2, 0, 2, 0, 'mm')),
    plot.margin = unit(c(5.5, 0, 5.5, 0), 'pt')
  )

poc_common_figure <- poc_common %>% 
  mutate(
    race = recode_factor(
      race,
      'native_hawaiian' = 'NH/PI',
      'american_indian' = 'AI/AN',
      'black' = 'Black',
      'asian' = 'Asian',
      'white' = 'White',
      'is_hisp' = 'Latinx'
    )
  ) %>% 
  ggplot(aes(x = race, y = pct)) +
  geom_bar(stat = 'identity', fill = color_palette[[1]]) +
  geom_text(aes(label = str_c(round(pct * 100), '%')), hjust = -0.1, size = 2) +
  scale_y_continuous(expand = expansion(mult = c(0.01, 0.1))) +
  xlab('') + ylab('') +
  facet_wrap(~ factor(cbsa_name, levels = c('New York-Newark-Jersey City, NY-NJ-PA', 'Miami-Fort Lauderdale-West Palm Beach, FL', 'Houston-The Woodlands-Sugar Land, TX')), ncol = 1) +
  coord_flip() +
  theme(
    axis.text.x = element_blank(),
    axis.text.y = element_text(color = '#444444', size = 6, face = 'bold', hjust = 1),
    strip.text.x = element_text(color = NA, size = 7, face = 'bold', hjust = 0, margin = margin(2, 0, 2, 0, 'mm')),
    strip.background = element_rect(fill = '#f0f0f0', color = NA),
    plot.margin = unit(c(5.5, 0, 5.5, -20), 'pt')
  )

poc_cb_figure + poc_common_figure + plot_annotation(title = 'Aggregate race/ethnicity variable                                                                        Multiple races and ethnicities', theme = theme(plot.title = element_text(size = 7, color = 'black')))
```


---

## Purchased profiles for students of color by metro

```{r poc-prospects-deep-dive, fig.height = 4.5}
poc_hs_figure <- poc_hs %>% 
  left_join(poc_cb_totals, by = 'cbsa_code') %>% 
  mutate(
    control = recode_factor(
      control,
      'public' = 'Public HS',
      'private' = 'Private HS'
    ),
    count_type = recode_factor(
      ord_type,
      'prospect' = 'Prospects',
      'metro' = 'Metro'
    ),
    cbsa_name = str_c(cbsa_name, ' (N=', total, ')')
  ) %>% 
  filter(control == 'Private HS') %>% 
  ggplot(aes(y = count_type, x = pct, fill = control)) + 
  geom_bar(stat = 'identity', fill = color_palette[[1]]) + 
  geom_text(mapping = aes(label = str_c(round(pct * 100), '% ', control)), size = 2, hjust = -0.05) +
  scale_x_continuous(expand = expansion(mult = c(0, 0.04)), limits = c(0, 1.5)) +
  # scale_y_discrete(expand = expansion(mult = c(0.01, 0.1))) +
  xlab('') + ylab('') +
  facet_wrap(~ factor(cbsa_name, levels = c('New York-Newark-Jersey City, NY-NJ-PA (N=949)', 'Miami-Fort Lauderdale-West Palm Beach, FL (N=671)', 'Houston-The Woodlands-Sugar Land, TX (N=371)')), ncol = 1) +
  guides(fill = guide_legend(reverse = T)) +
  theme(
    # plot.background = element_rect(color = 'gray'),
    # panel.background = element_rect(color = 'red'),
    axis.text.x = element_blank(),
    axis.text.y = element_text(color = '#444444', size = 6, face = 'bold', hjust = 1),
    strip.text.x = element_text(size = 7, face = 'bold', hjust = 0, margin = margin(2, 0, 2, 0, 'mm')),
    plot.margin = unit(c(5.5, 0, 5.5, -10), 'pt')
  )

poc_income_figure <- poc_income %>% 
  add_row(cbsa_code = '26420', cbsa_name = 'Houston-The Woodlands-Sugar Land, TX', ord_type = 'public', income_2564 = 0) %>% 
  add_row(cbsa_code = '26420', cbsa_name = 'Houston-The Woodlands-Sugar Land, TX', ord_type = 'private', income_2564 = 0) %>% 
  add_row(cbsa_code = '33100', cbsa_name = 'Miami-Fort Lauderdale-West Palm Beach, FL', ord_type = 'public', income_2564 = 0) %>% 
  add_row(cbsa_code = '33100', cbsa_name = 'Miami-Fort Lauderdale-West Palm Beach, FL', ord_type = 'private', income_2564 = 0) %>% 
  add_row(cbsa_code = '35620', cbsa_name = 'New York-Newark-Jersey City, NY-NJ-PA', ord_type = 'public', income_2564 = 0) %>% 
  add_row(cbsa_code = '35620', cbsa_name = 'New York-Newark-Jersey City, NY-NJ-PA', ord_type = 'private', income_2564 = 0) %>% 
  mutate(
    count_type = recode_factor(
      ord_type,
      'private_1+' = '1+',
      'private_zero' = ' No buys',
      'private' = ' ',
      'public_6+' = '6+',
      'public_1-5' = '1-5',
      'public_zero' = 'No buys',
      'public' = '',
      'prospect' = 'Prospects',
      'metro' = 'Metro'
    ),
    cbsa_name = str_replace(str_replace(cbsa_name, 'Pompano', 'West Palm'), ' Metro Area', '')
  ) %>% 
  filter(str_detect(ord_type, 'private', T)) %>% 
  ggplot(aes(y = count_type, x = income_2564)) + 
  geom_bar(stat = 'identity', fill = color_palette[[2]]) + 
  geom_text(mapping = aes(label = if_else(income_2564 == 0, '', str_c('$', round(income_2564 / 1000), 'K'))), size = 2, hjust = -0.1) +
  geom_text(aes(label = if_else(income_2564 != 0, '', if_else(count_type == '', 'Public HS', 'Private HS')), x = 0), hjust = 0, vjust = 0.9, size = 2, fontface = 'bold') +
  scale_x_continuous(expand = expansion(mult = c(0, 0.04)), limits = c(0, 350000)) +
  scale_y_discrete(expand = expansion(mult = c(0.01, 0.1))) +
  xlab('') + ylab('') +
  facet_wrap(~ factor(cbsa_name, levels = c('New York-Newark-Jersey City, NY-NJ-PA', 'Miami-Fort Lauderdale-West Palm Beach, FL', 'Houston-The Woodlands-Sugar Land, TX')), ncol = 1) +
  guides(fill = guide_legend(reverse = T)) +
  theme(
    # plot.background = element_rect(color = 'gray'),
    # panel.background = element_rect(color = 'red'),
    axis.text.x = element_blank(),
    axis.text.y = element_text(color = '#444444', size = 6, face = 'bold', hjust = 1),
    strip.text.x = element_text(color = NA, size = 7, face = 'bold', hjust = 0, margin = margin(2, 0, 2, 0, 'mm')),
    plot.margin = unit(c(5.5, 0, 5.5, -120), 'pt')
  )

poc_race_figure <- poc_race %>% 
  # filter(count != 0) %>% 
  add_row(cbsa_code = '26420', cbsa_name = 'Houston-The Woodlands-Sugar Land, TX', ord_type = 'public', race = 'white', pct = 0) %>% 
  add_row(cbsa_code = '26420', cbsa_name = 'Houston-The Woodlands-Sugar Land, TX', ord_type = 'private', race = 'white', pct = 0) %>% 
  add_row(cbsa_code = '26420', cbsa_name = 'Houston-The Woodlands-Sugar Land, TX', ord_type = 'prospect', race = 'white', pct = 0) %>% 
  add_row(cbsa_code = '26420', cbsa_name = 'Houston-The Woodlands-Sugar Land, TX', ord_type = 'metro', race = 'white', pct = 0) %>% 
  add_row(cbsa_code = '33100', cbsa_name = 'Miami-Fort Lauderdale-West Palm Beach, FL', ord_type = 'public', race = 'white', pct = 0) %>% 
  add_row(cbsa_code = '33100', cbsa_name = 'Miami-Fort Lauderdale-West Palm Beach, FL', ord_type = 'private', race = 'white', pct = 0) %>% 
  add_row(cbsa_code = '33100', cbsa_name = 'Miami-Fort Lauderdale-West Palm Beach, FL', ord_type = 'prospect', race = 'white', pct = 0) %>% 
  add_row(cbsa_code = '33100', cbsa_name = 'Miami-Fort Lauderdale-West Palm Beach, FL', ord_type = 'metro', race = 'white', pct = 0) %>% 
  add_row(cbsa_code = '35620', cbsa_name = 'New York-Newark-Jersey City, NY-NJ-PA', ord_type = 'public', race = 'white', pct = 0) %>% 
  add_row(cbsa_code = '35620', cbsa_name = 'New York-Newark-Jersey City, NY-NJ-PA', ord_type = 'private', race = 'white', pct = 0) %>% 
  add_row(cbsa_code = '35620', cbsa_name = 'New York-Newark-Jersey City, NY-NJ-PA', ord_type = 'prospect', race = 'white', pct = 0) %>% 
  add_row(cbsa_code = '35620', cbsa_name = 'New York-Newark-Jersey City, NY-NJ-PA', ord_type = 'metro', race = 'white', pct = 0) %>% 
  mutate(
    race = recode_factor(
      race,
      'unknown' = 'Missing',
      'tworaces' = 'Multiracial',
      'nativehawaii' = 'NH/PI',
      'amerindian' = 'AI/AN',
      'hispanic' = 'Latinx',
      'black' = 'Black',
      'asian' = 'Asian',
      'white' = 'White'
    ),
    count_type = recode_factor(
      ord_type,
      'private_1+' = '1+',
      'private_zero' = ' No buys',
      'private' = ' ',
      'public_6+' = '6+',
      'public_1-5' = '1-5',
      'public_zero' = 'No buys',
      'public' = '',
      'prospect' = '  ',
      'metro' = '   '
    )
  ) %>% 
  filter(!race %in% c('Missing', 'No response'), str_detect(ord_type, 'private', T)) %>% 
  ggplot(aes(y = count_type, x = pct, fill = race)) + 
  geom_bar(position = 'stack', stat = 'identity', alpha = alpha_bar) + 
  geom_text(mapping = aes(label = if_else(pct > 0.02, as.character(round(pct * 100)), '')), size = 2, position = position_stack(vjust = 0.5), color = color_text) +
  geom_text(aes(label = if_else(str_detect(count_type, '\\w'), '', if_else(count_type == '', 'Public HS', '')), x = 0), hjust = 0, vjust = 0.9, size = 2, fontface = 'bold') +
  geom_text(aes(x = 1, fill = NULL, label = if_else(str_detect(count_type, '\\w'), str_c(' ', num_hs, ' HS', if_else(num_prospects > 0, str_c('\n ', num_prospects, ' prospects'), '')), '')), size = 1, hjust = 0) +
  # scale_fill_brewer(palette = 'BrBG', direction = -1, name = 'Race') +
  scale_fill_manual(values = rev(color_gradient[1:7]), name = 'Race') +
  scale_x_continuous(expand = expansion(mult = c(0, 0.04)), limits = c(0, 1.14)) +
  scale_y_discrete(expand = expansion(mult = c(0.01, 0.1))) +
  xlab('') + ylab('') +
  facet_wrap(~ factor(cbsa_name, levels = c('New York-Newark-Jersey City, NY-NJ-PA', 'Miami-Fort Lauderdale-West Palm Beach, FL', 'Houston-The Woodlands-Sugar Land, TX')), ncol = 1) +
  guides(fill = guide_legend(reverse = T)) +
  theme(
    # plot.background = element_rect(color = 'gray'),
    # panel.background = element_rect(color = 'red'),
    axis.text.x = element_blank(),
    axis.text.y = element_text(color = '#444444', size = 6, face = 'bold', hjust = 1),
    strip.text.x = element_text(color = NA, size = 7, face = 'bold', hjust = 0, margin = margin(2, 0, 2, 0, 'mm')),
    legend.margin = unit(c(0, 0, 0, 0), 'pt'),
    plot.margin = unit(c(4, 0, 5.5, -100), 'pt')
  )

grid.arrange(
  poc_hs_figure,
  poc_income_figure,
  poc_race_figure,
  ncol = 3,
  widths = c(2, 1, 1)
)
```



---

## Purchased profiles for students of color interactive map

<iframe src="https://mpatricia01.github.io/public_requests_eda/outputs/maps/map_poc.html" id="poc-prospects-deep-dive-map" width=100% height=100% allowtransparency="true"></iframe>


--- .section

# Policy


--- #references

# References
## &nbsp;

```{r results='asis', echo=FALSE, message=FALSE, warning=FALSE}
bibliography('html')
````
